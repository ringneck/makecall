rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // 1. users ì»¬ë ‰ì…˜ - ì‚¬ìš©ì ê³„ì • ì •ë³´
    // ============================================
    match /users/{userId} {
      // ë³¸ì¸ ë¬¸ì„œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // ğŸ”§ FIX: ìƒˆ ì‚¬ìš©ì ë¬¸ì„œ ìƒì„± í—ˆìš© (íšŒì›ê°€ì…/ì²« ë¡œê·¸ì¸ ì‹œ)
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // 2. my_extensions ì»¬ë ‰ì…˜ - ë‹¨ë§ë²ˆí˜¸ ì •ë³´
    // ============================================
    match /my_extensions/{documentId} {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³ , ë¬¸ì„œì˜ userId í•„ë“œê°€ ë³¸ì¸ê³¼ ì¼ì¹˜í•˜ë©´ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null 
                         && request.auth.uid == resource.data.userId;
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ (resource.data ì—†ìŒ)
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================
    // 3. call_history ì»¬ë ‰ì…˜ - í†µí™” ê¸°ë¡
    // ============================================
    match /call_history/{documentId} {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³ , ë¬¸ì„œì˜ userId í•„ë“œê°€ ë³¸ì¸ê³¼ ì¼ì¹˜í•˜ë©´ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null 
                         && request.auth.uid == resource.data.userId;
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================
    // 4. contacts ì»¬ë ‰ì…˜ - ì—°ë½ì²˜
    // ============================================
    match /contacts/{documentId} {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³ , ë¬¸ì„œì˜ userId í•„ë“œê°€ ë³¸ì¸ê³¼ ì¼ì¹˜í•˜ë©´ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null 
                         && request.auth.uid == resource.data.userId;
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================
    // 5. phonebook_contacts ì»¬ë ‰ì…˜ - ì£¼ì†Œë¡ ì—°ë½ì²˜
    // ============================================
    match /phonebook_contacts/{documentId} {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³ , ë¬¸ì„œì˜ userId í•„ë“œê°€ ë³¸ì¸ê³¼ ì¼ì¹˜í•˜ë©´ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null 
                         && request.auth.uid == resource.data.userId;
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================
    // 6. call_forward_info ì»¬ë ‰ì…˜ - ì°©ì‹ ì „í™˜ ì •ë³´
    // ============================================
    match /call_forward_info/{documentId} {
      // ğŸ”§ FIX: userId í•„ë“œ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ (documentId íŒ¨í„´ ë§¤ì¹­ ì œê±°)
      allow read, write: if request.auth != null 
                         && request.auth.uid == resource.data.userId;
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================
    // 7. fcm_tokens ì»¬ë ‰ì…˜ - FCM í† í° ê´€ë¦¬
    // ============================================
    match /fcm_tokens/{documentId} {
      // ğŸ”§ FIX: userId í•„ë“œ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ (documentId íŒ¨í„´ ë§¤ì¹­ ì œê±°)
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³ , ë¬¸ì„œì˜ userId í•„ë“œê°€ ë³¸ì¸ê³¼ ì¼ì¹˜í•˜ë©´ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null 
                         && request.auth.uid == resource.data.userId;
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================
    // 8. device_approval_requests ì»¬ë ‰ì…˜ - ê¸°ê¸° ìŠ¹ì¸ ìš”ì²­
    // ============================================
    match /device_approval_requests/{requestId} {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³ , ë¬¸ì„œì˜ userId í•„ë“œê°€ ë³¸ì¸ê³¼ ì¼ì¹˜í•˜ë©´ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null 
                         && request.auth.uid == resource.data.userId;
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================
    // 9. fcm_approval_notification_queue - FCM ìŠ¹ì¸ ì•Œë¦¼ í
    // ============================================
    match /fcm_approval_notification_queue/{queueId} {
      // ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ìê°€ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥ (ì•Œë¦¼ ì „ì†¡ìš©)
      allow read, write: if request.auth != null;
    }
    
    // ============================================
    // 10. settings ì»¬ë ‰ì…˜ - ì‚¬ìš©ì ì„¤ì •
    // ============================================
    match /settings/{userId} {
      // ë³¸ì¸ ì„¤ì •ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // 11. registered_extensions ì»¬ë ‰ì…˜ - ë“±ë¡ëœ ë‹¨ë§ë²ˆí˜¸
    // ============================================
    match /registered_extensions/{documentId} {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì´ê³ , ë¬¸ì„œì˜ userId í•„ë“œê°€ ë³¸ì¸ê³¼ ì¼ì¹˜í•˜ë©´ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null 
                         && request.auth.uid == resource.data.userId;
      // ìƒˆ ë¬¸ì„œ ìƒì„± ì‹œ
      allow create: if request.auth != null 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================
    // ê¸°íƒ€ ëª¨ë“  ë¬¸ì„œ - ê¸°ë³¸ ê±°ë¶€
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
