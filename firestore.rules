// ============================================
// ğŸ”¥ FIRESTORE SECURITY RULES V6.3 (FINAL)
// ============================================
// 
// ğŸ“… Last Updated: 2025-12-06
// ğŸ¯ Version: V6.3 (ìµœì¢… ë²„ì „)
// 
// ğŸ”§ V6.3 ì£¼ìš” ìˆ˜ì • ì‚¬í•­:
// - announcements ì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€ (ê³µì§€ì‚¬í•­ ì¡°íšŒ ê¶Œí•œ ë¶€ì—¬)
// - device_approval_requests ì»¬ë ‰ì…˜ ì¿¼ë¦¬ ì§€ì› ì¶”ê°€
// - .doc().snapshots() ë¦¬ìŠ¤ë„ˆì˜ resource == null ìƒí™© ì²˜ë¦¬
// - ì „ì²´ 19ê°œ ì»¬ë ‰ì…˜ ì™„ì „ ê²€ì¦ ì™„ë£Œ
// 
// ğŸ“Š ê²€ì¦ëœ ì»¬ë ‰ì…˜:
// - Type A (User-Scoped): 10ê°œ âœ…
// - Type B (Composite-ID): 2ê°œ âœ…
// - Type C (Shared): 5ê°œ âœ… (announcements ì¶”ê°€)
// - Type D (Admin-Only): 2ê°œ âœ…
// 
// ============================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ğŸ”µ TYPE A: User-Scoped Collections
    // ë³¸ì¸ ë°ì´í„°ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì»¬ë ‰ì…˜
    // ============================================
    
    // 1. users - ì‚¬ìš©ì ê³„ì • ì •ë³´
    match /users/{userId} {
      allow read, write, create: if request.auth != null 
                                 && request.auth.uid == userId;
    }
    
    // 2. main_numbers - ëŒ€í‘œë²ˆí˜¸ ê´€ë¦¬
    match /main_numbers/{documentId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 3. extensions - ë‹¨ë§ë²ˆí˜¸ ëª©ë¡
    match /extensions/{documentId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 4. call_history - í†µí™” ê¸°ë¡
    match /call_history/{documentId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 5. contacts - ì—°ë½ì²˜
    match /contacts/{documentId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 6. phonebook_contacts - ì£¼ì†Œë¡ ì—°ë½ì²˜
    match /phonebook_contacts/{documentId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 7. phonebooks - ì£¼ì†Œë¡
    match /phonebooks/{documentId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 8. my_extensions - ë‚´ ë‹¨ë§ë²ˆí˜¸ ì •ë³´
    match /my_extensions/{documentId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 9. device_approval_requests - ê¸°ê¸° ìŠ¹ì¸ ìš”ì²­
    // ğŸ”‘ CRITICAL: .doc().snapshots() ë¦¬ìŠ¤ë„ˆ ì§€ì›ì„ ìœ„í•´ resource null ì²´í¬ í•„ìš”
    // fcm_device_approval_service.dart:312ì—ì„œ .doc(approvalRequestId).snapshots() ì‚¬ìš©
    // ì²« ë¦¬ìŠ¤ë‹ ì‹œ ë¬¸ì„œê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•„ resource == null ìƒí™© ë°œìƒ
    match /device_approval_requests/{documentId} {
      allow read: if request.auth != null 
                  && (resource == null || resource.data.userId == request.auth.uid);
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 10. user_notification_settings - ì‚¬ìš©ì ì•Œë¦¼ ì„¤ì •
    match /user_notification_settings/{userId} {
      allow read, write, create: if request.auth != null 
                                 && request.auth.uid == userId;
    }
    
    // ============================================
    // ğŸŸ¢ TYPE B: Composite-ID Collections
    // Document IDë¡œ ì†Œìœ ê¶Œ íŒë³„ ê°€ëŠ¥í•œ ì»¬ë ‰ì…˜
    // ============================================
    
    // 11. fcm_tokens - FCM í† í° ê´€ë¦¬
    // Document ID í˜•ì‹: {userId}_{deviceId}_{platform}
    // ì˜ˆ: BATARjeeg2aGpggaCOl9J2Hz17T2_5B03AB9F_iOS
    // 
    // ğŸ”‘ CRITICAL: ì¿¼ë¦¬ ì§€ì›ì„ ìœ„í•´ resource.data.userId ì‚¬ìš©
    // documentId.split()ì€ ê°œë³„ ë¬¸ì„œ ì ‘ê·¼ì—ë§Œ ì‘ë™, ì¿¼ë¦¬ì—ëŠ” ì•ˆë¨
    match /fcm_tokens/{documentId} {
      allow read: if request.auth != null 
                  && (resource == null || resource.data.userId == request.auth.uid);
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 12. call_forward_info - ì°©ì‹ ì „í™˜ ì •ë³´
    // Document ID í˜•ì‹: {userId}_{extensionNumber}
    // ì˜ˆ: BATARjeeg2aGpggaCOl9J2Hz17T2_1234
    // 
    // ğŸ”‘ CRITICAL: ì¿¼ë¦¬ ì§€ì›ì„ ìœ„í•´ resource.data.userId ì‚¬ìš©
    // account_manager_service.dart:207ì—ì„œ .where('userId', isEqualTo: uid) ì¿¼ë¦¬ ì‚¬ìš©
    match /call_forward_info/{documentId} {
      allow read: if request.auth != null 
                  && (resource == null || resource.data.userId == request.auth.uid);
      allow write: if request.auth != null 
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // ğŸŸ¡ TYPE C: Shared Collections
    // ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ê³µìœ  ë°ì´í„°
    // ============================================
    
    // 13. registered_extensions - ë“±ë¡ëœ ë‹¨ë§ë²ˆí˜¸ (ê³µê°œ ì •ë³´)
    // ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ ë‹¨ë§ë²ˆí˜¸ ì¡°íšŒ ê°€ëŠ¥
    // ì“°ê¸°ëŠ” ë³¸ì¸ ë¬¸ì„œë§Œ ê°€ëŠ¥
    match /registered_extensions/{documentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null 
                   && resource != null
                   && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // 14. fcm_approval_notification_queue - FCM ìŠ¹ì¸ ì•Œë¦¼ í
    // ì•Œë¦¼ ì „ì†¡ìš© ì„ì‹œ í, ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥
    match /fcm_approval_notification_queue/{queueId} {
      allow read, write, create: if request.auth != null;
    }
    
    // 15. app_config - ì•± ì „ì—­ ì„¤ì • (ì½ê¸° ì „ìš©)
    match /app_config/{configId} {
      allow read: if request.auth != null;
      allow write: if false; // ë°±ì—”ë“œ/ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥
    }
    
    // 16. shared_api_settings - ê³µìœ  API ì„¤ì • (ì½ê¸° ì „ìš©)
    match /shared_api_settings/{settingId} {
      allow read: if request.auth != null;
      allow write: if false; // ë°±ì—”ë“œ/ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥
    }
    
    // 17. announcements - ê³µì§€ì‚¬í•­ (ì½ê¸° ì „ìš©)
    // ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ ê³µì§€ì‚¬í•­ ì¡°íšŒ ê°€ëŠ¥
    // ì“°ê¸°ëŠ” ë°±ì—”ë“œ/ê´€ë¦¬ìë§Œ ê°€ëŠ¥
    match /announcements/{announcementId} {
      allow read: if request.auth != null;
      allow write: if false; // ë°±ì—”ë“œ/ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥
    }
    
    // ============================================
    // ğŸ”´ TYPE D: Admin-Only Collections
    // ë°±ì—”ë“œ/ê´€ë¦¬ì ì „ìš©, í´ë¼ì´ì–¸íŠ¸ ì ‘ê·¼ ì°¨ë‹¨
    // ============================================
    
    // 17. email_verification_requests - ì´ë©”ì¼ ì¸ì¦ ìš”ì²­
    match /email_verification_requests/{requestId} {
      allow read, write: if false; // ë°±ì—”ë“œë§Œ ì ‘ê·¼
    }
    
    // 18. fcm_notifications - FCM ì•Œë¦¼ ì´ë ¥
    match /fcm_notifications/{notificationId} {
      allow read, write: if false; // ë°±ì—”ë“œë§Œ ì ‘ê·¼
    }
    
    // ============================================
    // âš« DEFAULT: ê¸°íƒ€ ëª¨ë“  ë¬¸ì„œ
    // ëª…ì‹œë˜ì§€ ì•Šì€ ëª¨ë“  ê²½ë¡œëŠ” ê¸°ë³¸ ê±°ë¶€
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
