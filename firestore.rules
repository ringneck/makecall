rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // 사용자 문서 (개발 환경용 - 간소화된 규칙)
    // ============================================
    match /users/{userId} {
      // 로그인한 사용자가 자신의 문서 읽기/쓰기 가능
      // 소셜 로그인 자동 등록 지원
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // FCM 토큰 관리
    // ============================================
    match /fcm_tokens/{tokenId} {
      // 로그인한 사용자만 읽기/쓰기 가능
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ============================================
    // 기기 승인 요청 (다중 기기 로그인)
    // ============================================
    match /device_approval_requests/{requestId} {
      // 자신의 userId와 일치하는 요청만 읽기 가능
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      
      // 로그인한 사용자만 새 요청 생성 가능
      allow create: if request.auth != null;
      
      // 자신의 userId와 일치하는 요청만 업데이트 가능
      allow update: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
      
      // 삭제는 불가 (만료 처리로 대체)
      allow delete: if false;
    }
    
    // ============================================
    // 이메일 인증 요청
    // ============================================
    match /email_verification_requests/{requestId} {
      // 자신의 userId와 일치하는 요청만 읽기 가능
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      
      // 로그인한 사용자만 새 요청 생성 가능
      allow create: if request.auth != null;
      
      // 자신의 userId와 일치하는 요청만 업데이트 가능
      // (코드 사용 여부 표시)
      allow update: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
      
      // 삭제는 Cloud Functions에서만 처리
      allow delete: if false;
    }
    
    // ============================================
    // FCM 알림 큐 (Cloud Functions 전용)
    // ============================================
    match /fcm_approval_notification_queue/{queueId} {
      // 클라이언트 접근 완전 차단
      // Cloud Functions에서만 읽기/쓰기 가능
      allow read, write: if false;
    }
    
    match /fcm_force_logout_queue/{queueId} {
      // 클라이언트 접근 완전 차단
      // Cloud Functions에서만 읽기/쓰기 가능
      allow read, write: if false;
    }
    
    // ============================================
    // 내선 번호 관리
    // ============================================
    match /my_extensions/{extensionId} {
      // 로그인한 사용자만 자신의 내선번호 읽기/쓰기 가능
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow write: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // 착신 전환 정보
    // ============================================
    match /call_forward_info/{infoId} {
      // 로그인한 사용자만 자신의 착신전환 정보 읽기/쓰기 가능
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow write: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // 알림 설정
    // ============================================
    match /user_notification_settings/{userId} {
      // 로그인한 사용자만 자신의 알림 설정 읽기/쓰기 가능
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // 전화번호부 연락처 (Phonebook Contacts)
    // ============================================
    match /phonebook_contacts/{contactId} {
      // 로그인한 사용자만 자신의 연락처 읽기/쓰기 가능
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // 전화번호부 (Phonebooks)
    // ============================================
    match /phonebooks/{phonebookId} {
      // 로그인한 사용자만 자신의 전화번호부 읽기/쓰기 가능
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // 연락처 (Contacts)
    // ============================================
    match /contacts/{contactId} {
      // 로그인한 사용자만 자신의 연락처 읽기/쓰기 가능
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // 통화 기록 (Call History)
    // ============================================
    match /call_history/{historyId} {
      // 로그인한 사용자만 자신의 통화 기록 읽기 가능
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      
      // 로그인한 사용자만 자신의 통화 기록 생성 가능
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      
      // 통화 확인 업데이트: 로그인 여부와 관계없이 userId 일치 시 허용
      // (로그아웃 상태에서 푸시 알림으로 받은 통화 확인 가능)
      allow update: if resource.data.userId == request.resource.data.userId &&
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']));
      
      // 로그인한 사용자만 자신의 통화 기록 삭제 가능
      allow delete: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // 내선번호 (Extensions)
    // ============================================
    match /extensions/{extensionId} {
      // 로그인한 사용자는 모든 내선번호 읽기 가능 (조직 내 공유)
      allow read: if request.auth != null;
      // 쓰기는 관리자만 가능 (현재는 차단)
      allow write: if false;
    }
    
    // ============================================
    // 등록된 내선번호 (Registered Extensions)
    // ============================================
    match /registered_extensions/{extensionId} {
      // 로그인한 사용자는 모든 등록된 내선번호 읽기 가능
      allow read: if request.auth != null;
      // 쓰기는 제한
      allow write: if false;
    }
    
    // ============================================
    // 대표번호 (Main Numbers)
    // ============================================
    match /main_numbers/{numberId} {
      // 로그인한 사용자는 모든 대표번호 읽기 가능
      allow read: if request.auth != null;
      // 쓰기는 관리자만 가능 (현재는 차단)
      allow write: if false;
    }
    
    // ============================================
    // 기본 규칙 (모든 다른 컬렉션 차단)
    // ============================================
    match /{document=**} {
      // 명시적으로 허용되지 않은 모든 접근 차단
      allow read, write: if false;
    }
  }
}
