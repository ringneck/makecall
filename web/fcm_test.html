<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FCM ì›¹ í‘¸ì‹œ í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      font-size: 14px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .token-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin: 15px 0;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
    }
    .log {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
    }
    .log-entry {
      margin: 5px 0;
    }
    .copy-btn {
      background: #28a745;
      font-size: 12px;
      padding: 8px 16px;
    }
    .copy-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”” FCM ì›¹ í‘¸ì‹œ í…ŒìŠ¤íŠ¸</h1>
    <p>ì´ í˜ì´ì§€ë¡œ Firebase Cloud Messaging ì›¹ í‘¸ì‹œ ì•Œë¦¼ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div id="status" class="status info">
      â³ ì´ˆê¸°í™” ì¤‘...
    </div>

    <div>
      <button id="requestPermission">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</button>
      <button id="getToken" disabled>FCM í† í° ê°€ì ¸ì˜¤ê¸°</button>
      <button id="sendTest" disabled>í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°</button>
      <button id="clearLogs">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <div id="tokenContainer" style="display: none;">
      <h3>FCM í† í°</h3>
      <div class="token-box" id="tokenDisplay"></div>
      <button class="copy-btn" id="copyToken">í† í° ë³µì‚¬</button>
    </div>

    <div>
      <h3>ì½˜ì†” ë¡œê·¸</h3>
      <div class="log" id="logContainer"></div>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
      <strong>ğŸ“ ì‚¬ìš© ë°©ë²•:</strong>
      <ol style="margin: 10px 0; padding-left: 20px;">
        <li><strong>"ì•Œë¦¼ ê¶Œí•œ ìš”ì²­"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•©ë‹ˆë‹¤.</li>
        <li><strong>"FCM í† í° ê°€ì ¸ì˜¤ê¸°"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê³ ìœ  í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤.</li>
        <li>ìƒì„±ëœ í† í°ì„ ë³µì‚¬í•˜ì—¬ Firebase Consoleì—ì„œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.</li>
        <li>ë˜ëŠ” <strong>"í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°"</strong> ë²„íŠ¼ìœ¼ë¡œ ë°”ë¡œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</li>
      </ol>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js';

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: 'AIzaSyCB4mI5Kj61f6E532vg46GnmnnCfsI9XIM',
      appId: '1:793164633643:android:c2f267d67b908274ccfc6e',
      messagingSenderId: '793164633643',
      projectId: 'makecallio',
      authDomain: 'makecallio.firebaseapp.com',
      storageBucket: 'makecallio.firebasestorage.app',
    };

    // VAPID í‚¤ (Firebase Console â†’ Project Settings â†’ Cloud Messaging â†’ Web Push certificates)
    const vapidKey = 'BM2qgTRRwT-mG4shgKLDr7CnVf5-xVs3DqNNcqY7zzHZXd5P5xWqvCLn8BxGnqJ3YKj0zcY6Kp0YwQ_Zr8vK2jM';

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    let fcmToken = null;

    // DOM ìš”ì†Œ
    const statusDiv = document.getElementById('status');
    const logContainer = document.getElementById('logContainer');
    const tokenContainer = document.getElementById('tokenContainer');
    const tokenDisplay = document.getElementById('tokenDisplay');
    const requestPermissionBtn = document.getElementById('requestPermission');
    const getTokenBtn = document.getElementById('getToken');
    const sendTestBtn = document.getElementById('sendTest');
    const copyTokenBtn = document.getElementById('copyToken');
    const clearLogsBtn = document.getElementById('clearLogs');

    // ë¡œê·¸ í•¨ìˆ˜
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
      logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
      
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
      
      console.log(message);
    }

    function setStatus(message, type = 'info') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }

    // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    requestPermissionBtn.addEventListener('click', async () => {
      try {
        log('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì¤‘...');
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
          log('âœ… ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨!', 'success');
          setStatus('âœ… ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨. FCM í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
          getTokenBtn.disabled = false;
        } else {
          log('âŒ ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨', 'error');
          setStatus('âŒ ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'error');
        }
      } catch (error) {
        log(`âŒ ê¶Œí•œ ìš”ì²­ ì˜¤ë¥˜: ${error.message}`, 'error');
        setStatus('âŒ ê¶Œí•œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
      }
    });

    // FCM í† í° ê°€ì ¸ì˜¤ê¸°
    getTokenBtn.addEventListener('click', async () => {
      try {
        log('FCM í† í° ìš”ì²­ ì¤‘...');
        setStatus('â³ FCM í† í° ìƒì„± ì¤‘...', 'info');
        
        fcmToken = await getToken(messaging, { vapidKey });
        
        if (fcmToken) {
          log(`âœ… FCM í† í° ìƒì„± ì™„ë£Œ! (ê¸¸ì´: ${fcmToken.length}ì)`, 'success');
          log(`í† í° ì•ë¶€ë¶„: ${fcmToken.substring(0, 30)}...`);
          
          tokenDisplay.textContent = fcmToken;
          tokenContainer.style.display = 'block';
          
          setStatus('âœ… FCM í† í°ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. Firebase Consoleì—ì„œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
          sendTestBtn.disabled = false;
        } else {
          log('âŒ FCM í† í° ìƒì„± ì‹¤íŒ¨: í† í°ì´ null', 'error');
          setStatus('âŒ FCM í† í° ìƒì„± ì‹¤íŒ¨', 'error');
        }
      } catch (error) {
        log(`âŒ FCM í† í° ì˜¤ë¥˜: ${error.message}`, 'error');
        setStatus(`âŒ FCM í† í° ì˜¤ë¥˜: ${error.message}`, 'error');
        
        if (error.code === 'messaging/permission-blocked') {
          log('ğŸ’¡ í•´ê²°ë°©ë²•: ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”');
        }
      }
    });

    // í† í° ë³µì‚¬
    copyTokenBtn.addEventListener('click', () => {
      if (fcmToken) {
        navigator.clipboard.writeText(fcmToken).then(() => {
          log('âœ… í† í°ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          copyTokenBtn.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
          setTimeout(() => {
            copyTokenBtn.textContent = 'í† í° ë³µì‚¬';
          }, 2000);
        });
      }
    });

    // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸° (ë¸Œë¼ìš°ì € ìì²´ ì•Œë¦¼)
    sendTestBtn.addEventListener('click', () => {
      if (Notification.permission === 'granted') {
        log('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ ì¤‘...');
        const notification = new Notification('ğŸ”” í…ŒìŠ¤íŠ¸ ì•Œë¦¼', {
          body: 'ì›¹ í‘¸ì‹œ ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!',
          icon: '/icons/Icon-192.png',
          badge: '/icons/Icon-192.png',
          requireInteraction: false,
          tag: 'test-notification'
        });
        
        notification.onclick = () => {
          log('âœ… ì•Œë¦¼ì´ í´ë¦­ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          window.focus();
          notification.close();
        };
        
        log('âœ… í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } else {
        log('âŒ ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'error');
      }
    });

    // ë¡œê·¸ ì§€ìš°ê¸°
    clearLogsBtn.addEventListener('click', () => {
      logContainer.innerHTML = '';
      log('ë¡œê·¸ë¥¼ ì§€ì› ìŠµë‹ˆë‹¤');
    });

    // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
    onMessage(messaging, (payload) => {
      log('ğŸ“¨ í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ !', 'success');
      log(`ì œëª©: ${payload.notification?.title || 'ì œëª© ì—†ìŒ'}`);
      log(`ë‚´ìš©: ${payload.notification?.body || 'ë‚´ìš© ì—†ìŒ'}`);
      
      // ì•Œë¦¼ í‘œì‹œ
      if (Notification.permission === 'granted') {
        const notification = new Notification(
          payload.notification?.title || 'MakeCall ì•Œë¦¼',
          {
            body: payload.notification?.body || 'ìƒˆë¡œìš´ ì•Œë¦¼ì´ ìˆìŠµë‹ˆë‹¤.',
            icon: payload.notification?.icon || '/icons/Icon-192.png',
            data: payload.data
          }
        );
      }
    });

    // Service Worker ë“±ë¡ í™•ì¸
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        log(`Service Worker ë“±ë¡ ê°œìˆ˜: ${registrations.length}`);
        registrations.forEach(reg => {
          log(`- ${reg.active?.scriptURL || 'ë¹„í™œì„±'}`);
        });
      });
    }

    // ì´ˆê¸° ìƒíƒœ í™•ì¸
    window.addEventListener('load', () => {
      log('ğŸš€ FCM í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
      log(`ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ: ${Notification.permission}`);
      log(`Service Worker ì§€ì›: ${('serviceWorker' in navigator) ? 'âœ…' : 'âŒ'}`);
      log(`HTTPS: ${location.protocol === 'https:' ? 'âœ…' : 'âŒ'}`);
      
      if (Notification.permission === 'granted') {
        setStatus('âœ… ì•Œë¦¼ ê¶Œí•œì´ ì´ë¯¸ í—ˆìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤. FCM í† í°ì„ ê°€ì ¸ì˜¤ì„¸ìš”.', 'success');
        getTokenBtn.disabled = false;
      } else if (Notification.permission === 'denied') {
        setStatus('âŒ ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'error');
        log('ğŸ’¡ Chrome ì„¤ì • â†’ ê°œì¸ì •ë³´ ë° ë³´ì•ˆ â†’ ì‚¬ì´íŠ¸ ì„¤ì • â†’ ì•Œë¦¼');
      } else {
        setStatus('â„¹ï¸ ì•Œë¦¼ ê¶Œí•œì„ ìš”ì²­í•˜ì„¸ìš”.', 'info');
      }
    });
  </script>
</body>
</html>
