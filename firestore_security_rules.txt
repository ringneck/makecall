rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ================================
    // ì‚¬ìš©ì ê´€ë ¨ ì»¬ë ‰ì…˜
    // ================================
    
    // ì‚¬ìš©ì ì •ë³´ (users)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ì‚¬ìš©ì ì•Œë¦¼ ì„¤ì • (user_notification_settings)
    match /user_notification_settings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ================================
    // FCM ë° ë””ë°”ì´ìŠ¤ ê´€ë¦¬
    // ================================
    
    // FCM í† í° (fcm_tokens)
    match /fcm_tokens/{tokenId} {
      // ì‚¬ìš©ìëŠ” ìì‹ ì˜ í† í°ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null 
                         && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // âœ… NEW: ë””ë°”ì´ìŠ¤ ìŠ¹ì¸ ì•Œë¦¼ í (fcm_approval_notification_queue)
    match /fcm_approval_notification_queue/{docId} {
      // ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ìì‹ ì˜ ì•Œë¦¼ í ìƒì„± ê°€ëŠ¥
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      
      // Cloud Functionsë§Œ ì½ê¸°/ì—…ë°ì´íŠ¸/ì‚­ì œ ê°€ëŠ¥ (processed í”Œë˜ê·¸ ì—…ë°ì´íŠ¸ìš©)
      allow read, update, delete: if false; // í´ë¼ì´ì–¸íŠ¸ ì ‘ê·¼ ë¶ˆê°€
    }
    
    // âœ… NEW: ë””ë°”ì´ìŠ¤ ìŠ¹ì¸ ìš”ì²­ (device_approval_requests)
    match /device_approval_requests/{docId} {
      // ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ìì‹ ì˜ ìŠ¹ì¸ ìš”ì²­ ìƒì„± ê°€ëŠ¥
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      
      // ğŸ”§ FIX: ë¬¸ì„œ IDì— userId í¬í•¨ëœ ê²½ìš°ë„ í—ˆìš© (userId_deviceId_platform í˜•ì‹)
      // ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ìì‹ ì˜ ìŠ¹ì¸ ìš”ì²­ ì½ê¸°/ì—…ë°ì´íŠ¸ ê°€ëŠ¥
      allow read, update: if request.auth != null 
                          && (
                            // ë°©ë²• 1: ë¬¸ì„œ ë°ì´í„°ì˜ userId í™•ì¸
                            (resource != null && resource.data.userId == request.auth.uid)
                            ||
                            // ë°©ë²• 2: ë¬¸ì„œ IDê°€ ìì‹ ì˜ userIdë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
                            docId.matches(request.auth.uid + '_.*')
                          );
      
      // ì‚­ì œëŠ” Cloud Functionsë§Œ ê°€ëŠ¥ (ë§Œë£Œëœ ìš”ì²­ ì •ë¦¬)
      allow delete: if false;
    }
    
    // ê°•ì œ ë¡œê·¸ì•„ì›ƒ í (fcm_force_logout_queue) - ë ˆê±°ì‹œ ì§€ì›
    match /fcm_force_logout_queue/{docId} {
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if false; // Cloud Functionsë§Œ ì ‘ê·¼
    }
    
    // ================================
    // ë‹¨ë§ë²ˆí˜¸ ë° ì°©ì‹ ì „í™˜
    // ================================
    
    // ë‚´ ë‹¨ë§ë²ˆí˜¸ (my_extensions)
    match /my_extensions/{extensionId} {
      allow read, write: if request.auth != null 
                         && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // ì°©ì‹ ì „í™˜ ì •ë³´ (call_forward_info)
    match /call_forward_info/{infoId} {
      allow read, write: if request.auth != null 
                         && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // ================================
    // í†µí™” ê´€ë ¨ ì»¬ë ‰ì…˜
    // ================================
    
    // í†µí™” ê¸°ë¡ (call_history)
    match /call_history/{callId} {
      allow read, write: if request.auth != null 
                         && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
    }
    
    // í†µí™” ê¸°ë¡ ì„ì‹œ ì €ì¥ (call_history_temp) - Cloud Functionsìš©
    match /call_history_temp/{callId} {
      allow read, write: if request.auth != null;
    }
    
    // ================================
    // ê¸°íƒ€
    // ================================
    
    // ê¸°ë³¸ ê·œì¹™: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
